<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>판다마켓 - 실시간 알림</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f6fa;
        padding: 2rem;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .status {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .status.connected {
        color: #27ae60;
      }

      .user-select {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .user-select label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .user-select select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
      }

      .notification-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #ecf0f1;
      }

      .notification-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .unread-badge {
        background: #e74c3c;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .mark-all-read {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .mark-all-read:hover {
        background: #2980b9;
      }

      .notification-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .notification-item {
        padding: 1rem;
        border-bottom: 1px solid #ecf0f1;
        cursor: pointer;
        transition: background 0.2s;
      }

      .notification-item:hover {
        background: #f8f9fa;
      }

      .notification-item.unread {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
      }

      .notification-item-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .notification-item-message {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .notification-item-time {
        color: #95a5a6;
        font-size: 0.8rem;
      }

      .test-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .test-panel h3 {
        margin-bottom: 1rem;
        color: #2c3e50;
      }

      .test-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .test-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: transform 0.2s;
      }

      .test-btn:hover {
        transform: translateY(-2px);
      }

      .btn-price {
        background: #f39c12;
        color: white;
      }

      .btn-post {
        background: #9b59b6;
        color: white;
      }

      .btn-product {
        background: #1abc9c;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #95a5a6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>판다마켓 실시간 알림 (Socket.IO)</h1>
        <div class="status" id="status">서버 연결 중...</div>
      </header>

      <div class="user-select">
        <label for="userSelect">사용자 선택:</label>
        <select id="userSelect">
          <option value="">사용자를 선택하세요</option>
          <option value="1">사용자 1</option>
          <option value="2">사용자 2</option>
          <option value="3">사용자 3</option>
        </select>
      </div>

      <div class="notification-panel">
        <div class="notification-header">
          <div>
            <span class="notification-title">알림</span>
            <span class="unread-badge" id="unreadBadge">0</span>
          </div>
          <button class="mark-all-read" id="markAllRead">모두 읽음</button>
        </div>
        <div class="notification-list" id="notificationList">
          <div class="empty-state">사용자를 선택하면 알림이 표시됩니다</div>
        </div>
      </div>

      <div class="test-panel">
        <h3>테스트 알림 생성</h3>
        <div class="test-buttons">
          <button class="test-btn btn-price" onclick="sendTestNotification('PRODUCT_PRICE_CHANGE')">
            가격 변경 알림
          </button>
          <button class="test-btn btn-post" onclick="sendTestNotification('POST_COMMENT')">
            게시글 댓글 알림
          </button>
          <button class="test-btn btn-product" onclick="sendTestNotification('PRODUCT_COMMENT')">
            상품 댓글 알림
          </button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket;
      let currentUserId = null;
      const statusEl = document.getElementById('status');
      const userSelect = document.getElementById('userSelect');
      const notificationList = document.getElementById('notificationList');
      const unreadBadge = document.getElementById('unreadBadge');
      const markAllReadBtn = document.getElementById('markAllRead');

      function connectSocket() {
        socket = io();

        socket.on('connect', () => {
          statusEl.textContent = '✅ 서버 연결됨';
          statusEl.classList.add('connected');
          console.log('Socket.IO 연결됨:', socket.id);

          if (currentUserId) {
            socket.emit('authenticate', parseInt(currentUserId));
          }
        });

        socket.on('unread_count', (data) => {
          updateUnreadBadge(data.count);
        });

        socket.on('notifications_list', (data) => {
          renderNotifications(data.notifications);
        });

        socket.on('new_notification', (data) => {
          showToast(data.notification.title);
          loadNotifications();
        });

        socket.on('marked_read', () => {
          loadNotifications();
        });

        socket.on('all_marked_read', () => {
          loadNotifications();
        });

        socket.on('disconnect', () => {
          statusEl.textContent = '⚠️ 서버 연결 끊김 (재연결 중...)';
          statusEl.classList.remove('connected');
        });

        socket.on('reconnect', () => {
          statusEl.textContent = '✅ 서버 재연결됨';
          statusEl.classList.add('connected');
          if (currentUserId) {
            socket.emit('authenticate', parseInt(currentUserId));
            loadNotifications();
          }
        });
      }

      userSelect.addEventListener('change', (e) => {
        currentUserId = e.target.value;
        if (currentUserId && socket.connected) {
          socket.emit('authenticate', parseInt(currentUserId));
          loadNotifications();
        } else {
          notificationList.innerHTML = '<div class="empty-state">사용자를 선택하면 알림이 표시됩니다</div>';
          updateUnreadBadge(0);
        }
      });

      markAllReadBtn.addEventListener('click', () => {
        if (currentUserId && socket.connected) {
          socket.emit('mark_all_read', parseInt(currentUserId));
        }
      });

      function loadNotifications() {
        if (currentUserId && socket.connected) {
          socket.emit('get_notifications', parseInt(currentUserId));
        }
      }

      function renderNotifications(notifications) {
        if (notifications.length === 0) {
          notificationList.innerHTML = '<div class="empty-state">알림이 없습니다</div>';
          return;
        }

        const unreadCount = notifications.filter(n => !n.is_read).length;
        updateUnreadBadge(unreadCount);

        notificationList.innerHTML = notifications.map(n => `
          <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="markAsRead(${n.id})">
            <div class="notification-item-title">${n.title}</div>
            <div class="notification-item-message">${n.message}</div>
            <div class="notification-item-time">${formatTime(n.created_at)}</div>
          </div>
        `).join('');
      }

      function markAsRead(notificationId) {
        if (socket.connected) {
          socket.emit('mark_read', notificationId);
        }
      }

      function updateUnreadBadge(count) {
        unreadBadge.textContent = count;
        unreadBadge.style.display = count > 0 ? 'inline-block' : 'none';
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return '방금 전';
        if (diff < 3600) return `${Math.floor(diff / 60)}분 전`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}시간 전`;
        return date.toLocaleDateString('ko-KR');
      }

      function showToast(message) {
        if (Notification.permission === 'granted') {
          new Notification('판다마켓', { body: message });
        }
      }

      async function sendTestNotification(type) {
        if (!currentUserId) {
          alert('먼저 사용자를 선택하세요');
          return;
        }

        const messages = {
          'PRODUCT_PRICE_CHANGE': {
            title: '좋아요한 상품 가격이 변경되었습니다',
            message: '"iPhone 15 Pro" 상품의 가격이 1,200,000원에서 1,000,000원으로 인하되었습니다.'
          },
          'POST_COMMENT': {
            title: '내 게시글에 새 댓글이 달렸습니다',
            message: 'testuser님이 "판다마켓 사용 후기" 게시글에 댓글을 남겼습니다: 정말 좋은 정보네요!'
          },
          'PRODUCT_COMMENT': {
            title: '내 상품에 새 댓글이 달렸습니다',
            message: 'buyer123님이 "MacBook Pro" 상품에 댓글을 남겼습니다: 구매하고 싶습니다!'
          }
        };

        await fetch('/api/test-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: parseInt(currentUserId),
            type: type,
            ...messages[type]
          })
        });
      }

      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }

      connectSocket();
    </script>
  </body>
</html>
